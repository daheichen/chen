<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI 关键帧提取器 (Pro版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .selected-ring { box-shadow: 0 0 0 4px #3b82f6; }
        /* 简单的 Toast 提示动画 */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        /* 悬停显示复制按钮 */
        .card-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .group:hover .card-actions {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen font-sans">

    <div id="toast" class="toast">已复制到剪贴板</div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">UI 关键帧提取器 <span class="text-blue-600 text-sm align-top bg-blue-100 px-2 py-0.5 rounded-full">Pro</span></h1>
                <p class="text-gray-500 text-sm mt-1">智能识别 -> 一键复制到 Figma/文档</p>
            </div>
            <button id="resetBtn" class="hidden text-red-600 hover:bg-red-50 border border-red-200 font-medium py-2 px-4 rounded transition flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                清空重置
            </button>
        </header>

        <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-xl p-16 text-center bg-white hover:bg-gray-50 transition cursor-pointer mb-8">
            <input type="file" id="videoInput" accept="video/*" class="hidden">
            <div class="space-y-4 pointer-events-none">
                <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto">
                    <svg class="h-10 w-10 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-medium text-gray-700">点击上传界面录屏</h3>
                    <p class="text-gray-400 mt-1">支持 MP4, MOV 等格式 • 本地安全处理</p>
                </div>
            </div>
        </div>

        <div id="processingPanel" class="hidden bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span id="statusText" class="font-medium text-gray-700">正在分析视频...</span>
                </div>
                <span id="progressText" class="text-sm text-gray-500">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4 flex flex-col md:flex-row gap-6 text-sm">
                <div class="flex-1">
                    <label class="block text-gray-700 font-medium mb-1">识别灵敏度</label>
                    <input type="range" id="thresholdRange" min="5" max="40" value="15" class="w-full accent-blue-600 h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>捕捉微小动效</span>
                        <span>只抓页面跳转</span>
                    </div>
                </div>
                <div class="flex items-end">
                    <button id="reprocessBtn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded shadow-sm transition w-full disabled:opacity-50">
                        应用设置并重新分析
                    </button>
                </div>
            </div>
        </div>

        <div id="resultToolbar" class="hidden sticky top-0 z-20 bg-gray-50/95 backdrop-blur py-4 border-b border-gray-200 mb-6 flex flex-wrap gap-3 justify-between items-center">
            <div class="flex items-center space-x-4">
                <h2 class="text-lg font-bold text-gray-800">识别结果 <span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full text-sm" id="countSpan">0</span></h2>
                <div class="text-sm space-x-2">
                    <button id="selectAllBtn" class="text-blue-600 hover:underline font-medium">全选</button>
                    <span class="text-gray-300">|</span>
                    <button id="deselectAllBtn" class="text-gray-500 hover:underline">取消</button>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="batchCopyBtn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-sm transition flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    复制选中 (Doc)
                </button>
                <button id="downloadBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow transition flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    下载打包
                </button>
            </div>
        </div>

        <div id="gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 pb-20"></div>
    </div>

    <video id="hiddenVideo" muted class="hidden"></video>
    <canvas id="hiddenCanvas" class="hidden"></canvas>
    <canvas id="compareCanvas" width="64" height="64" class="hidden"></canvas>

    <script>
        // --- 核心变量 ---
        const els = {
            uploadArea: document.getElementById('uploadArea'),
            videoInput: document.getElementById('videoInput'),
            processingPanel: document.getElementById('processingPanel'),
            resultToolbar: document.getElementById('resultToolbar'),
            gallery: document.getElementById('gallery'),
            resetBtn: document.getElementById('resetBtn'),
            progressBar: document.getElementById('progressBar'),
            statusText: document.getElementById('statusText'),
            progressText: document.getElementById('progressText'),
            hiddenVideo: document.getElementById('hiddenVideo'),
            hiddenCanvas: document.getElementById('hiddenCanvas'),
            compareCanvas: document.getElementById('compareCanvas'),
            reprocessBtn: document.getElementById('reprocessBtn'),
            thresholdRange: document.getElementById('thresholdRange'),
            countSpan: document.getElementById('countSpan'),
            downloadBtn: document.getElementById('downloadBtn'),
            batchCopyBtn: document.getElementById('batchCopyBtn')
        };

        let state = {
            capturedFrames: [], // { id, time, dataUrl, blob, selected }
            lastFrameData: null,
            isProcessing: false,
            videoUrl: null
        };

        // --- 事件监听 ---
        els.resetBtn.addEventListener('click', resetApp);
        
        els.uploadArea.addEventListener('click', () => els.videoInput.click());
        els.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); els.uploadArea.classList.add('bg-blue-50', 'border-blue-400'); });
        els.uploadArea.addEventListener('dragleave', () => els.uploadArea.classList.remove('bg-blue-50', 'border-blue-400'));
        els.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            els.uploadArea.classList.remove('bg-blue-50', 'border-blue-400');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        els.videoInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        els.reprocessBtn.addEventListener('click', () => processVideo());
        els.downloadBtn.addEventListener('click', downloadSelected);
        els.batchCopyBtn.addEventListener('click', batchCopy);
        
        document.getElementById('selectAllBtn').addEventListener('click', () => toggleAll(true));
        document.getElementById('deselectAllBtn').addEventListener('click', () => toggleAll(false));

        // --- 逻辑函数 ---

        function handleFile(file) {
            if (state.videoUrl) URL.revokeObjectURL(state.videoUrl);
            state.videoUrl = URL.createObjectURL(file);
            els.hiddenVideo.src = state.videoUrl;
            
            // 界面切换
            els.uploadArea.classList.add('hidden');
            els.processingPanel.classList.remove('hidden');
            els.resetBtn.classList.remove('hidden');
            
            els.hiddenVideo.onloadedmetadata = () => {
                els.hiddenCanvas.width = els.hiddenVideo.videoWidth;
                els.hiddenCanvas.height = els.hiddenVideo.videoHeight;
                processVideo();
            };
        }

        function resetApp() {
            // 停止可能的处理
            state.isProcessing = false; 
            
            // 清理数据
            state.capturedFrames = [];
            els.gallery.innerHTML = '';
            els.videoInput.value = ''; // 清空 input 防止重复上传不触发
            
            // 还原界面
            els.uploadArea.classList.remove('hidden');
            els.processingPanel.classList.add('hidden');
            els.resultToolbar.classList.add('hidden');
            els.resetBtn.classList.add('hidden');
            
            showToast("已重置，请上传新视频");
        }

        async function processVideo() {
            if (state.isProcessing) return;
            state.isProcessing = true;
            
            // 重置UI状态
            els.gallery.innerHTML = '';
            state.capturedFrames = [];
            state.lastFrameData = null;
            els.resultToolbar.classList.add('hidden');
            els.reprocessBtn.disabled = true;
            els.reprocessBtn.innerText = "分析中...";

            const duration = els.hiddenVideo.duration;
            const threshold = parseInt(els.thresholdRange.value);
            const step = 0.5; // 0.5秒采样一次
            let currentTime = 0;
            
            const ctx = els.hiddenCanvas.getContext('2d');
            const compareCtx = els.compareCanvas.getContext('2d', { willReadFrequently: true });

            function seek() {
                if (!state.isProcessing) return; // 支持中途取消/重置
                if (currentTime > duration) {
                    finishProcessing();
                    return;
                }
                els.hiddenVideo.currentTime = currentTime;
                
                // 更新进度
                const pct = Math.min(100, (currentTime/duration)*100).toFixed(0);
                els.progressBar.style.width = pct + '%';
                els.progressText.innerText = pct + '%';
            }

            els.hiddenVideo.onseeked = async () => {
                // 核心比对逻辑
                ctx.drawImage(els.hiddenVideo, 0, 0, els.hiddenCanvas.width, els.hiddenCanvas.height);
                compareCtx.drawImage(els.hiddenVideo, 0, 0, 64, 64);
                const currentData = compareCtx.getImageData(0, 0, 64, 64).data;

                let isDiff = false;
                if (!state.lastFrameData) {
                    isDiff = true;
                } else {
                    const diff = calculateDiff(state.lastFrameData, currentData);
                    if (diff > threshold) isDiff = true;
                }

                if (isDiff) {
                    state.lastFrameData = currentData;
                    const blob = await new Promise(r => els.hiddenCanvas.toBlob(r, 'image/png'));
                    const url = URL.createObjectURL(blob);
                    
                    const frame = {
                        id: Date.now() + Math.random(),
                        time: currentTime,
                        dataUrl: url, // 用于显示
                        blob: blob,   // 用于复制/下载
                        selected: true
                    };
                    state.capturedFrames.push(frame);
                    addCard(frame);
                    els.countSpan.innerText = state.capturedFrames.length;
                }

                currentTime += step;
                requestAnimationFrame(seek);
            };

            seek();
        }

        function calculateDiff(d1, d2) {
            let diff = 0;
            for (let i = 0; i < d1.length; i += 16) { // 简单采样优化速度
                diff += Math.abs(d1[i] - d2[i]) + Math.abs(d1[i+1] - d2[i+1]) + Math.abs(d1[i+2] - d2[i+2]);
            }
            return (diff / (255 * 3 * (d1.length / 16))) * 100;
        }

        function finishProcessing() {
            state.isProcessing = false;
            els.resultToolbar.classList.remove('hidden');
            els.reprocessBtn.disabled = false;
            els.reprocessBtn.innerText = "应用设置并重新分析";
            els.statusText.innerText = "分析完成";
        }

        // --- 卡片 UI 生成 ---
        function addCard(frame) {
            const div = document.createElement('div');
            div.className = "group relative transition";
            div.innerHTML = `
                <div class="relative rounded-lg overflow-hidden border border-gray-200 shadow bg-white cursor-pointer ${frame.selected ? 'selected-ring' : ''}" id="card-${frame.id}">
                    <img src="${frame.dataUrl}" class="w-full h-auto object-cover bg-gray-100 aspect-[9/16]" onclick="toggleSelect(${frame.id})">
                    
                    <div class="card-actions absolute inset-0 bg-black bg-opacity-10 flex items-center justify-center pointer-events-none">
                        <button onclick="copySingle(event, ${frame.id})" class="pointer-events-auto bg-white hover:bg-blue-50 text-gray-800 font-semibold py-2 px-4 rounded-full shadow-lg transform translate-y-4 group-hover:translate-y-0 transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                            复制
                        </button>
                    </div>

                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                        ${formatTime(frame.time)}
                    </div>
                    
                    <div class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full border-2 border-gray-300 flex items-center justify-center pointer-events-none">
                        ${frame.selected ? '<div class="w-4 h-4 bg-blue-500 rounded-full"></div>' : ''}
                    </div>
                </div>
            `;
            els.gallery.appendChild(div);
        }

        // --- 功能操作 ---

        function toggleSelect(id) {
            const frame = state.capturedFrames.find(f => f.id === id);
            if (frame) {
                frame.selected = !frame.selected;
                // 暴力重绘选中状态
                const card = document.getElementById(`card-${id}`);
                const check = card.querySelector('.absolute.top-2');
                if (frame.selected) {
                    card.classList.add('selected-ring');
                    check.innerHTML = '<div class="w-4 h-4 bg-blue-500 rounded-full"></div>';
                } else {
                    card.classList.remove('selected-ring');
                    check.innerHTML = '';
                }
                updateBtnState();
            }
        }

        function toggleAll(status) {
            state.capturedFrames.forEach(f => {
                if (f.selected !== status) toggleSelect(f.id);
            });
        }

        // 复制单张 (完美支持 Figma)
        async function copySingle(e, id) {
            e.stopPropagation(); // 防止触发选中
            const frame = state.capturedFrames.find(f => f.id === id);
            if (!frame) return;

            try {
                // 向剪贴板写入 PNG blob
                const item = new ClipboardItem({ "image/png": frame.blob });
                await navigator.clipboard.write([item]);
                showToast("已复制！可直接粘贴到 Figma");
            } catch (err) {
                console.error(err);
                showToast("复制失败，请尝试右键复制");
            }
        }

        // 批量复制 (HTML 格式，适合文档)
        async function batchCopy() {
            const selected = state.capturedFrames.filter(f => f.selected);
            if (selected.length === 0) return showToast("请先选择图片");

            // 构建 HTML <img> 标签字符串 (注意：很多平台需要 base64)
            // 为了兼容性，我们尝试生成 HTML 内容写入剪贴板
            // 注意：Figma 不支持批量 HTML 图片粘贴，但 Word/Notion 支持
            
            showToast("正在准备批量复制...");
            
            try {
                // 将所有 Blob 转为 Base64 以嵌入 HTML
                const imgTags = await Promise.all(selected.map(async (f) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(`<img src="${reader.result}" /><br/>`);
                        reader.readAsDataURL(f.blob);
                    });
                }));

                const htmlContent = imgTags.join('');
                const blobText = new Blob([htmlContent], { type: 'text/html' });
                const item = new ClipboardItem({ 'text/html': blobText });
                
                await navigator.clipboard.write([item]);
                showToast(`已复制 ${selected.length} 张图片！(适合粘贴到文档)`);
            } catch (err) {
                console.error(err);
                showToast("批量复制失败，浏览器可能不支持");
            }
        }

        async function downloadSelected() {
            const selected = state.capturedFrames.filter(f => f.selected);
            if (!selected.length) return showToast("请先选择图片");
            
            const zip = new JSZip();
            selected.forEach((f, i) => zip.file(`UI_Screen_${i+1}.png`, f.blob));
            
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "UI_Keyframes.zip");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function updateBtnState() {
            const count = state.capturedFrames.filter(f => f.selected).length;
            els.batchCopyBtn.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg> 复制选中 (${count})`;
        }

        function formatTime(s) {
            return Math.floor(s/60) + ':' + (Math.floor(s%60)).toString().padStart(2,'0');
        }
    </script>
</body>
</html>
